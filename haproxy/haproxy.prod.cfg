# =============================================================================
# HAProxy Production Configuration — Whisper Chat Application
# =============================================================================
# SSL termination, WebSocket routing, rate limiting, connection draining
# =============================================================================

global
    maxconn 200000
    log stdout format raw local0

    # Buffer tuning for large WebSocket frames
    tune.bufsize 32768
    tune.ssl.default-dh-param 2048

    # Runtime management socket
    stats socket /var/run/haproxy/admin.sock mode 660 level admin expose-fd listeners

# =============================================================================
# Defaults
# =============================================================================

defaults
    mode http
    log global
    option httplog
    option dontlognull
    option forwardfor

    timeout connect 5s
    timeout client 3600s
    timeout server 3600s
    timeout tunnel 3600s
    timeout http-request 10s
    timeout http-keep-alive 10s
    timeout queue 30s

# =============================================================================
# Stats Frontend — monitoring on dedicated port
# =============================================================================

frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /haproxy/stats
    stats refresh 10s
    stats show-legends
    stats show-node
    stats auth admin:whisper_haproxy_stats

# =============================================================================
# HTTP Frontend — redirect all traffic to HTTPS
# =============================================================================

frontend http_front
    bind *:80
    http-request redirect scheme https code 301

# =============================================================================
# HTTPS Frontend — SSL termination and routing
# =============================================================================

frontend https_front
    bind *:443 ssl crt /etc/haproxy/certs/whisper.pem alpn h2,http/1.1
    mode http

    # -------------------------------------------------------------------------
    # SSL hardening
    # -------------------------------------------------------------------------
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384

    # HSTS header (1 year, includeSubDomains)
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # -------------------------------------------------------------------------
    # Rate limiting — stick-table tracking connection rate per source IP
    # -------------------------------------------------------------------------
    stick-table type ip size 200k expire 30s store conn_rate(10s)
    http-request track-sc0 src
    http-request deny deny_status 429 if { sc_conn_rate(0) gt 100 }

    # -------------------------------------------------------------------------
    # ACLs for request routing
    # -------------------------------------------------------------------------
    acl is_websocket hdr(Upgrade) -i WebSocket
    acl is_ws_path   path_beg /ws
    acl is_api_path  path_beg /api/

    # -------------------------------------------------------------------------
    # Routing rules
    # -------------------------------------------------------------------------
    # WebSocket upgrades and /ws path -> ws_servers backend
    use_backend ws_servers if is_websocket
    use_backend ws_servers if is_ws_path
    # API requests -> ws_servers backend
    use_backend ws_servers if is_api_path
    # Everything else -> frontend (static files served by nginx)
    default_backend frontend

# =============================================================================
# Backend: ws_servers — WebSocket + API application servers
# =============================================================================

backend ws_servers
    balance leastconn

    # Sticky sessions via cookie
    cookie SERVERID insert indirect nocache

    # Connection draining
    option redispatch
    retries 3

    # Health checks
    option httpchk GET /health
    http-check expect status 200

    # Application servers with slow start and health checks
    server wsserver-1 wsserver-1:8080 check cookie wsserver-1 slowstart 30s
    server wsserver-2 wsserver-2:8080 check cookie wsserver-2 slowstart 30s

# =============================================================================
# Backend: frontend — static files served by nginx
# =============================================================================

backend frontend
    server frontend frontend:8080 check
    option httpchk GET /
    http-check expect status 200
